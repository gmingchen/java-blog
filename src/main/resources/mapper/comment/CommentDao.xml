<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.slipper.modules.comment.dao.CommentDao">

    <resultMap type="com.slipper.modules.comment.entity.CommentEntity" id="commentMap">
        <result property="id" column="id"/>
        <result property="content" column="content"/>
        <result property="articleId" column="article_id"/>
        <result property="userId" column="user_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

<!--    IPage<CommentDto> queryPage(Page<CommentDto> page,-->
<!--    @Param("start") Integer id,-->
<!--    @Param("start") String start,-->
<!--    @Param("end") String end,-->
<!--    @Param("name") String name);-->
    <select id="queryPage" resultType="com.slipper.modules.comment.model.dto.CommentDto">
        SELECT c.id, c.content, c.article_id, c.user_id, c.created_at,
                u.username, u.nickname, u.avatar, u.sex
        FROM comment AS c
        LEFT JOIN user AS u ON u.id = c.user_id
        <where>
            c.article_id = #{id} AND c.deleted = 0
            <if test="name != null or name !=''">
                AND (u.username LIKE "%${name}%" OR u.nickname LIKE "%${name}%")
            </if>
            <if test="start != null and start != ''">
                AND DATE_FORMAT(c.created_at,'%Y-%m-%d') <![CDATA[ >= ]]> DATE_FORMAT(#{start},'%Y-%m-%d')
            </if>
            <if test="end != null and end != ''">
                AND DATE_FORMAT(c.created_at,'%Y-%m-%d') <![CDATA[ <= ]]> DATE_FORMAT(#{end},'%Y-%m-%d')
            </if>
        </where>
        ORDER BY c.created_at DESC
    </select>

<!--    List<CommentBasicDto> queryLatest(@Param("limit") int limit);-->
    <select id="queryLatest" resultType="com.slipper.modules.comment.model.dto.CommentBasicDto">
        SELECT c.id, c.content, c.article_id, c.user_id, c.created_at,
                a.title AS article_title, u.username, u.nickname
        FROM comment AS c
        LEFT JOIN article AS a ON a.id = c.article_id
        LEFT JOIN user AS u ON u.id = c.user_id
        WHERE c.deleted = 0
        ORDER BY c.created_at DESC
        LIMIT #{limit}
    </select>
</mapper>